name: Coverage Badge

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies
      run: |
        uv sync --extra test

    - name: Run tests with coverage
      run: |
        uv run pytest --cov --cov-report=term --cov-report=json

    - name: Extract coverage percentage
      id: coverage
      run: |
        COVERAGE=$(uv run python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered_display'])")
        echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Coverage: $COVERAGE%"

    - name: Create coverage badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: ${{ secrets.GIST_ID }}
        filename: audio-stream-server-coverage.json
        label: Coverage
        message: ${{ steps.coverage.outputs.percentage }}%
        valColorRange: ${{ steps.coverage.outputs.percentage }}
        maxColorRange: 100
        minColorRange: 0

    - name: Comment coverage on commit
      if: github.event_name == 'push'
      run: |
        echo "Coverage: ${{ steps.coverage.outputs.percentage }}%" >> $GITHUB_STEP_SUMMARY
