<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Usage Statistics - YouTube Radio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css?v=1737842303">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .stats-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .stats-header h1 {
            font-size: 1.75rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .back-btn {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .filters {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-group select,
        .filter-group input {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.625rem;
            font-size: 0.9rem;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .filter-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-sub {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .chart-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            height: 400px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .usage-table {
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            overflow-x: auto;
        }

        .usage-table h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-primary);
        }

        .provider-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .provider-openai {
            background: rgba(16, 163, 127, 0.2);
            color: #10a37f;
        }

        .provider-gemini {
            background: rgba(66, 133, 244, 0.2);
            color: #4285f4;
        }

        .feature-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            background: rgba(124, 58, 237, 0.2);
            color: var(--accent-primary);
        }

        .cost-breakdown {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            border: 1px solid var(--border-color);
        }

        .cost-breakdown h2 {
            margin: 0 0 1.5rem 0;
            font-size: 1.25rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cost-items {
            display: grid;
            gap: 0.75rem;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .cost-item:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-primary);
        }

        .cost-item-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .cost-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .cost-item-icon.transcription {
            background: rgba(16, 163, 127, 0.2);
            color: #10a37f;
        }

        .cost-item-icon.summarization {
            background: rgba(124, 58, 237, 0.2);
            color: var(--accent-primary);
        }

        .cost-item-icon.weekly_summary {
            background: rgba(66, 133, 244, 0.2);
            color: #4285f4;
        }

        .cost-item-info h3 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .cost-item-info p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .cost-item-right {
            text-align: right;
        }

        .cost-value {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .cost-percentage {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .stats-container {
                padding: 1rem 0.5rem;
            }

            .stats-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-header h1 {
                font-size: 1.5rem;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
                padding: 1rem;
            }

            .usage-table {
                padding: 1rem;
            }

            table {
                font-size: 0.8rem;
            }

            th,
            td {
                padding: 0.5rem 0.25rem;
            }
        }
    </style>
</head>

<body>
    <div class="stats-container">
        <div class="stats-header">
            <h1><i class="fas fa-chart-line"></i> LLM Usage Statistics</h1>
            <a href="/" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Player</span>
            </a>
        </div>

        <div class="filters">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="filter-provider">Provider</label>
                    <select id="filter-provider">
                        <option value="">All Providers</option>
                        <option value="openai">OpenAI</option>
                        <option value="gemini">Gemini</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-feature">Feature</label>
                    <select id="filter-feature">
                        <option value="">All Features</option>
                        <option value="transcription">Transcription</option>
                        <option value="summarization">Summarization</option>
                        <option value="weekly_summary">Weekly Summary</option>
                        <option value="weekly_summary_tts">Weekly Summary TTS</option>
                        <option value="book_suggestions">Book Suggestions</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-start-date">Start Date</label>
                    <input type="date" id="filter-start-date">
                </div>
                <div class="filter-group">
                    <label for="filter-end-date">End Date</label>
                    <input type="date" id="filter-end-date">
                </div>
            </div>
            <div class="filter-actions">
                <button onclick="applyFilters()" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button onclick="clearFilters()" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading statistics...</p>
        </div>

        <div id="stats-content" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">
                        <i class="fas fa-server"></i>
                        Total API Calls
                    </div>
                    <div class="stat-value" id="total-calls">0</div>
                    <div class="stat-sub">Across all providers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <i class="fas fa-coins"></i>
                        Total Tokens
                    </div>
                    <div class="stat-value" id="total-tokens">0</div>
                    <div class="stat-sub" id="token-breakdown">0 input / 0 output</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <i class="fas fa-dollar-sign"></i>
                        Estimated Cost
                    </div>
                    <div class="stat-value" id="estimated-cost">$0.00</div>
                    <div class="stat-sub">Based on average rates</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">
                        <i class="fas fa-fire"></i>
                        Most Used
                    </div>
                    <div class="stat-value" id="most-used" style="font-size: 1.2rem;">-</div>
                    <div class="stat-sub" id="most-used-count">-</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Token Usage by Provider</div>
                </div>
                <canvas id="provider-chart"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Usage by Feature</div>
                </div>
                <canvas id="feature-chart"></canvas>
            </div>

            <div class="cost-breakdown">
                <h2><i class="fas fa-dollar-sign"></i> Cost by Feature</h2>
                <div class="cost-items" id="cost-by-feature">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="usage-table">
                <h2><i class="fas fa-table"></i> Detailed Breakdown</h2>
                <table id="usage-table">
                    <thead>
                        <tr>
                            <th>Provider</th>
                            <th>Model</th>
                            <th>Feature</th>
                            <th>Calls</th>
                            <th>Total Tokens</th>
                            <th>Avg Tokens/Call</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentFilters = {};
        let providerChart = null;
        let featureChart = null;

        // Model pricing (per 1M tokens/characters)
        const MODEL_PRICING = {
            // OpenAI models
            'whisper-1': { input: 0, output: 0 }, // Whisper is priced per minute, not tokens
            'voxtral-mini-latest': { input: 0, output: 0 }, // Voxtral is priced per minute, not tokens
            'tts-1': { input: 15.00, output: 0 }, // TTS priced per character (stored in prompt_tokens)
            'tts-1-hd': { input: 30.00, output: 0 }, // TTS HD priced per character (stored in prompt_tokens)
            'gpt-5-nano': { input: 0.05, output: 0.40 },
            'gpt-4o-mini': { input: 0.15, output: 0.60 },
            'gpt-4o': { input: 2.50, output: 10.00 },
            'gpt-5.2': { input: 1.75, output: 14.00 },
            // ElevenLabs TTS models (priced per character, stored in prompt_tokens)
            'eleven_flash_v2_5': { input: 100.00, output: 0 }, // $0.10 per 1K chars
            'eleven_turbo_v2_5': { input: 300.00, output: 0 }, // $0.30 per 1K chars
            'eleven_multilingual_v2': { input: 300.00, output: 0 }, // $0.30 per 1K chars
            'eleven_monolingual_v1': { input: 300.00, output: 0 }, // $0.30 per 1K chars
            // Gemini models (text/summarization)
            'gemini-2.5-flash': { input: 0.15, output: 0.60 },
            'gemini-2.5-flash-preview-tts': { input: 0.15, output: 0.60 },
            'gemini-3-flash-preview': { input: 0.50, output: 3.00 },
            'gemini-3-pro-preview': { input: 2.00, output: 12.00 },
            'gemini-1.5-flash': { input: 0.15, output: 0.60 },
            'gemini-1.5-pro': { input: 2.00, output: 12.00 },
        };

        // Gemini audio transcription pricing (different from text)
        const GEMINI_AUDIO_PRICING = {
            input: 0.40,  // Average of $0.30-0.50 range
            output: 0.40
        };

        // Audio transcription pricing (per second)
        const AUDIO_PRICING_PER_SECOND = {
            'whisper-1': 0.0001,  // $0.006 per minute / 60
            'voxtral-mini-latest': 0.00005,  // $0.003 per minute / 60
        };

        function calculateCost(summary) {
            let totalCost = 0;

            summary.by_provider_model_feature.forEach(item => {
                const model = item.model;
                const feature = item.feature;
                const provider = item.provider;
                const audioDuration = item.total_audio_duration_seconds || 0;

                // Check if this model uses per-second audio pricing
                if (AUDIO_PRICING_PER_SECOND[model] && audioDuration > 0) {
                    const cost = audioDuration * AUDIO_PRICING_PER_SECOND[model];
                    totalCost += cost;
                    console.log(`${provider}/${model}/${feature}: ${(audioDuration / 60).toFixed(2)} minutes = $${cost.toFixed(4)}`);
                    return;
                }

                // Special handling for Gemini audio transcription
                let pricing = MODEL_PRICING[model];
                if (provider === 'gemini' && feature === 'transcription') {
                    pricing = GEMINI_AUDIO_PRICING;
                    console.log(`Using Gemini audio pricing for ${model} transcription`);
                }

                if (pricing) {
                    const inputTokens = item.total_prompt_tokens || 0;
                    const outputTokens = item.total_response_tokens || 0;

                    // Calculate cost: (tokens / 1,000,000) * price_per_million
                    const inputCost = (inputTokens / 1000000) * pricing.input;
                    const outputCost = (outputTokens / 1000000) * pricing.output;

                    totalCost += inputCost + outputCost;

                    console.log(`${provider}/${model}/${feature}: ${inputTokens} in, ${outputTokens} out = $${(inputCost + outputCost).toFixed(4)}`);
                } else {
                    // Unknown model - use average rate as fallback
                    console.warn(`Unknown model pricing: ${model}, using average rate`);
                    const totalTokens = item.total_tokens || 0;
                    totalCost += (totalTokens / 1000000) * 1.0; // $1 per 1M tokens fallback
                }
            });

            return totalCost;
        }

        async function loadStatistics() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('stats-content').style.display = 'none';

                // Build query string
                const params = new URLSearchParams();
                if (currentFilters.provider) params.append('provider', currentFilters.provider);
                if (currentFilters.feature) params.append('feature', currentFilters.feature);
                if (currentFilters.start_date) params.append('start_date', currentFilters.start_date);
                if (currentFilters.end_date) params.append('end_date', currentFilters.end_date);

                // Fetch summary data
                const response = await fetch(`/admin/llm-usage/summary?${params}`);
                const data = await response.json();

                if (data.status === 'success') {
                    updateSummaryCards(data.summary);
                    updateCharts(data.summary);
                    updateCostByFeature(data.summary);
                    updateTable(data.summary);

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('stats-content').style.display = 'block';
                } else {
                    throw new Error('Failed to load statistics');
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                document.getElementById('loading').innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Failed to load statistics</p>
                    <button onclick="loadStatistics()" class="btn btn-primary" style="margin-top: 1rem;">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                `;
            }
        }

        function updateSummaryCards(summary) {
            const totals = summary.totals;

            document.getElementById('total-calls').textContent = totals.call_count.toLocaleString();
            document.getElementById('total-tokens').textContent = totals.total_tokens.toLocaleString();
            document.getElementById('token-breakdown').textContent =
                `${totals.total_prompt_tokens.toLocaleString()} input / ${totals.total_response_tokens.toLocaleString()} output`;

            // Calculate accurate cost based on actual model pricing
            const estimatedCost = calculateCost(summary);
            document.getElementById('estimated-cost').textContent = `$${estimatedCost.toFixed(4)}`;

            // Update sub-label to show it's actual pricing
            const costCard = document.getElementById('estimated-cost').parentElement;
            const subLabel = costCard.querySelector('.stat-sub');
            if (estimatedCost < 0.01) {
                subLabel.textContent = `≈ $${(estimatedCost * 100).toFixed(2)}¢`;
            } else {
                subLabel.textContent = 'Based on actual model pricing';
            }

            // Find most used
            if (summary.by_provider_model_feature.length > 0) {
                const mostUsed = summary.by_provider_model_feature[0];
                document.getElementById('most-used').textContent = `${mostUsed.provider}/${mostUsed.model}`;
                document.getElementById('most-used-count').textContent =
                    `${mostUsed.call_count} calls, ${mostUsed.total_tokens.toLocaleString()} tokens`;
            }
        }

        function updateCharts(summary) {
            // Provider chart
            const providerData = {};
            summary.by_provider_model_feature.forEach(item => {
                if (!providerData[item.provider]) {
                    providerData[item.provider] = 0;
                }
                providerData[item.provider] += item.total_tokens;
            });

            const providerCtx = document.getElementById('provider-chart');
            if (providerChart) {
                providerChart.destroy();
            }

            providerChart = new Chart(providerCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(providerData),
                    datasets: [{
                        data: Object.values(providerData),
                        backgroundColor: [
                            'rgba(16, 163, 127, 0.8)',  // OpenAI green
                            'rgba(66, 133, 244, 0.8)',  // Gemini blue
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#e5e7eb',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ${context.parsed.toLocaleString()} tokens`;
                                }
                            }
                        }
                    }
                }
            });

            // Feature chart
            const featureData = {};
            summary.by_provider_model_feature.forEach(item => {
                if (!featureData[item.feature]) {
                    featureData[item.feature] = 0;
                }
                featureData[item.feature] += item.total_tokens;
            });

            const featureCtx = document.getElementById('feature-chart');
            if (featureChart) {
                featureChart.destroy();
            }

            featureChart = new Chart(featureCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(featureData),
                    datasets: [{
                        label: 'Total Tokens',
                        data: Object.values(featureData),
                        backgroundColor: 'rgba(124, 58, 237, 0.8)',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.parsed.y.toLocaleString()} tokens`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af',
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function updateCostByFeature(summary) {
            const container = document.getElementById('cost-by-feature');
            container.innerHTML = '';

            // Calculate cost per feature
            const featureCosts = {};
            const featureCalls = {};

            summary.by_provider_model_feature.forEach(item => {
                const feature = item.feature;
                const model = item.model;
                const provider = item.provider;
                const audioDuration = item.total_audio_duration_seconds || 0;

                // Check if this model uses per-second audio pricing
                if (AUDIO_PRICING_PER_SECOND[model] && audioDuration > 0) {
                    const cost = audioDuration * AUDIO_PRICING_PER_SECOND[model];
                    featureCosts[feature] = (featureCosts[feature] || 0) + cost;
                    featureCalls[feature] = (featureCalls[feature] || 0) + item.call_count;
                    return;
                }

                // Special handling for Gemini audio transcription
                let pricing = MODEL_PRICING[model];
                if (provider === 'gemini' && feature === 'transcription') {
                    pricing = GEMINI_AUDIO_PRICING;
                }

                if (pricing) {
                    const inputTokens = item.total_prompt_tokens || 0;
                    const outputTokens = item.total_response_tokens || 0;
                    const inputCost = (inputTokens / 1000000) * pricing.input;
                    const outputCost = (outputTokens / 1000000) * pricing.output;
                    const totalCost = inputCost + outputCost;

                    featureCosts[feature] = (featureCosts[feature] || 0) + totalCost;
                    featureCalls[feature] = (featureCalls[feature] || 0) + item.call_count;
                }
            });

            // Calculate total cost for percentages
            const totalCost = Object.values(featureCosts).reduce((sum, cost) => sum + cost, 0);

            // Sort features by cost (highest first)
            const sortedFeatures = Object.entries(featureCosts)
                .sort((a, b) => b[1] - a[1]);

            // Feature icons and display names
            const featureInfo = {
                'transcription': { icon: 'fa-microphone', name: 'Transcription', iconClass: 'transcription' },
                'summarization': { icon: 'fa-file-alt', name: 'Summarization', iconClass: 'summarization' },
                'weekly_summary': { icon: 'fa-calendar-week', name: 'Weekly Summary', iconClass: 'weekly_summary' },
                'book_suggestions': { icon: 'fa-book', name: 'Book Suggestions', iconClass: 'summarization' },
                'tts': { icon: 'fa-volume-up', name: 'Text-to-Speech', iconClass: 'weekly_summary' },
                'weekly_summary_tts': { icon: 'fa-volume-up', name: 'Weekly Summary TTS', iconClass: 'weekly_summary' }
            };

            sortedFeatures.forEach(([feature, cost]) => {
                const calls = featureCalls[feature];
                const percentage = totalCost > 0 ? (cost / totalCost * 100) : 0;
                const avgCostPerCall = calls > 0 ? cost / calls : 0;
                const info = featureInfo[feature] || { icon: 'fa-cog', name: feature, iconClass: 'summarization' };

                const costItem = document.createElement('div');
                costItem.className = 'cost-item';
                costItem.innerHTML = `
                    <div class="cost-item-left">
                        <div class="cost-item-icon ${info.iconClass}">
                            <i class="fas ${info.icon}"></i>
                        </div>
                        <div class="cost-item-info">
                            <h3>${info.name}</h3>
                            <p>${calls.toLocaleString()} calls • $${avgCostPerCall.toFixed(6)} avg/call</p>
                        </div>
                    </div>
                    <div class="cost-item-right">
                        <div class="cost-value">$${cost.toFixed(4)}</div>
                        <div class="cost-percentage">${percentage.toFixed(1)}% of total</div>
                    </div>
                `;
                container.appendChild(costItem);
            });

            // Show message if no data
            if (sortedFeatures.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No cost data available</p>';
            }
        }

        function updateTable(summary) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            summary.by_provider_model_feature.forEach(item => {
                const avgTokens = Math.round(item.total_tokens / item.call_count);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="provider-badge provider-${item.provider}">${item.provider}</span></td>
                    <td>${item.model}</td>
                    <td><span class="feature-badge">${item.feature}</span></td>
                    <td>${item.call_count}</td>
                    <td>${item.total_tokens.toLocaleString()}</td>
                    <td>${avgTokens.toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function applyFilters() {
            currentFilters = {
                provider: document.getElementById('filter-provider').value,
                feature: document.getElementById('filter-feature').value,
                start_date: document.getElementById('filter-start-date').value ?
                    new Date(document.getElementById('filter-start-date').value).toISOString() : '',
                end_date: document.getElementById('filter-end-date').value ?
                    new Date(document.getElementById('filter-end-date').value).toISOString() : ''
            };
            loadStatistics();
        }

        function clearFilters() {
            document.getElementById('filter-provider').value = '';
            document.getElementById('filter-feature').value = '';
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            currentFilters = {};
            loadStatistics();
        }

        // Initial load
        loadStatistics();

        // Set default date range to last 30 days
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);
        document.getElementById('filter-start-date').value = startDate.toISOString().split('T')[0];
        document.getElementById('filter-end-date').value = endDate.toISOString().split('T')[0];
    </script>
</body>

</html>
